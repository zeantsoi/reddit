<% from r2.lib.pages import AppDeveloper %>
<%namespace name="utils" file="utils.html" />
<%namespace file="utils.html" import="error_field, plain_link" />
<%namespace file="printablebuttons.html" import="ynbutton" />

<%def name="icon(app)">
  <div class="app-icon">
    <img src="${app.icon_url}">&nbsp;
  </div>
</%def>

<%def name="developers(app)">
  <% devs = app._developers %>
  %if devs:
    <div class="app-developers">
      Developers:&#32;
      %for i, dev in enumerate(devs):
        %if i:
          %if i == len(devs) - 1:
            &#32;and&#32;
          %else:
            ,&#32;
          %endif
        %endif
        ${plain_link(dev.name, "/u/" + dev.name)}
      %endfor
    </div>
  %endif
</%def>

%if thing.my_apps:
  <h1>${_("authorized applications")}</h1>

  %for app in thing.my_apps:
  <div id="authorized-app-${app._id}" class="authorized-app rounded">
    ${icon(app)}
    <div class="app-details">
      <h2>
      %if app.about_url:
        <a href="${app.about_url}">${app.name}</a>
      %else:
        ${app.name}
      %endif
      </h2>
      <div class="app-description">${app.description}</div>
      ${developers(app)}
      ${ynbutton(_("revoke access"),
                 _("revoked"),
                 "revokeapp",
                 callback="app_revoked",
                 hidden_data=dict(client_id=app._id),
                 _class="revoke-app-button")}
    </div>
  </div>
  %endfor
%endif

%if thing.developed_apps:
  <h1>${_("developed applications")}</h1>

  %for app in thing.developed_apps:
  <div id="developed-app-${app._id}" class="developed-app rounded">
    ${icon(app)}
    <div class="app-details">
      <h2>
      %if app.about_url:
        <a href="${app.about_url}">${app.name}</a>
      %else:
        ${app.name}
      %endif
      </h2>
      <h3>${app._id}</h3>
      <div class="app-description">${app.description}</div>
      ${developers(app)}
      <a class="edit-app-button" href="javascript:void(0)">
         ${_("edit")}
      </a>
    </div>
    <div class="edit-app">
      %if thing.can_upload_icon:
        <a class="edit-app-icon-button" href="javascript:void(0)">
          change icon
        </a>
        <%utils:ajax_upload target="/api/setappicon"
                            form_id="app-icon-upload-${app._id}">
          <input type="hidden" name="client_id" value="${app._id}" />
          ${error_field('NOT_SUPPORTED', '')}
          ${error_field('TOO_LONG', 'file')}
          ${error_field('BAD_IMAGE', 'file')}
        </%utils:ajax_upload>
      %endif
      <div class="edit-app-form">
        <form method="post" action="/api/updateapp" class="pretty-form"
         id="update-app-${app._id}"
         onsubmit="${"return post_form(this, 'updateapp', function(x) {return '%s'})" % _("updating...")}">
          <input type="hidden" name="uh" value="${c.modhash}" />
          <input type="hidden" name="client_id" value="${app._id}" />
          <table class="preftable">
            <tr>
              <th>${_("secret")}</th>
              <td class="prefright">${app.secret}</td>
            </tr>
            <tr>
              <th>${_("name")}</th>
              <td class="prefright">
                <input name="name" value="${app.name}">
                ${error_field("NO_TEXT", "name")}
              </td>
            </tr>
            <tr>
              <th>${_("description")}</th>
              <td class="prefright">
                <textarea name="description">${app.description}</textarea>
              </td>
            </tr>
            <tr>
              <th>${_("about url")}</th>
              <td class="prefright">
                <input name="about_url" value="${app.about_url}">
                ${error_field("BAD_URL", "about_url")}
              </td>
            </tr>
            <tr>
              <th>${_("redirect uri")}</th>
              <td class="prefright">
                <input name="redirect_uri"
                 value="${app.redirect_uri}">
                ${error_field("NO_URL", "redirect_uri")}
                ${error_field("BAD_URL", "redirect_uri")}
              </td>
            </tr>
          </table>
          <input type="submit" value="update app">
          <span class="status"></span>
        </form>
      </div>
      <div class="edit-app-form pretty-form">
        <table class="preftable">
          <tr>
            <th>${_("developers")}</th>
            <td class="prefright">
              <ul>
                %for dev in app._developers:
                  ${AppDeveloper(app, dev)}
                %endfor
              </ul>
              <br>
              <form method="post" action="/api/adddeveloper"
               class="pretty-form" id="app-developer-${app._id}"
               onsubmit="${"return post_form(this, 'adddeveloper', function(x) {return '%s'})" % _("adding...")}">
                <input type="hidden" name="uh" value="${c.modhash}" />
                <input type="hidden" name="client_id" value="${app._id}" />
                ${_('add developer')}: <input name="name">
                <br>
                <span class="status"></span>
              </form>
            </td>
          </tr>
        </table>
      </div>
      <div class="delete-app-button">
        ${ynbutton(_("delete app"),
                   "deleted",
                   "deleteapp",
                   callback="app_deleted",
                   hidden_data=dict(client_id=app._id))}
      </div>
    </div>
  </div>
  %endfor
  <p><a href="#">create another app...</a></p>
%else:
  <p><a href="#">are you a developer?  create an app...</a></p>
%endif

<div class="edit-app-form">
  <button id="create-app-button" class="submit-img">
    ${_("create application")}
  </button>
  <form method="post" action="/api/updateapp" class="pretty-form" id="create-app"
   onsubmit="${"return post_form(this, 'updateapp', function(x) {return '%s'})" % _("creating...")}">
    <h1>${_("create application")}</h1>
    <input type="hidden" name="uh" value="${c.modhash}" />
    <table class="content preftable">
      <tr>
        <th>${_("name")}</th>
        <td class="prefright">
          <input name="name">
          ${error_field("NO_TEXT", "name")}
        </td>
      </tr>
      <tr>
        <th>${_("description")}</th>
        <td class="prefright">
          <textarea name="description"></textarea>
        </td>
      </tr>
      <tr>
        <th>${_("about url")}</th>
        <td class="prefright">
          <input name="about_url">
          ${error_field("BAD_URL", "about_url")}
        </td>
      </tr>
      <tr>
        <th>${_("redirect uri")}</th>
        <td class="prefright">
          <input name="redirect_uri">
          ${error_field("NO_URL", "redirect_uri")}
          ${error_field("BAD_URL", "redirect_uri")}
        </td>
      </tr>
    </table>
    <input type="submit" value="create app">
    <span class="status"></span>
  </form>
</div>
