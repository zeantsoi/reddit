## The contents of this file are subject to the Common Public Attribution
## License Version 1.0. (the "License"); you may not use this file except in
## compliance with the License. You may obtain a copy of the License at
## http://code.reddit.com/LICENSE. The License is based on the Mozilla Public
## License Version 1.1, but Sections 14 and 15 have been added to cover use of
## software over a computer network and provide for limited attribution for the
## Original Developer. In addition, Exhibit A has been modified to be consistent
## with Exhibit B.
## 
## Software distributed under the License is distributed on an "AS IS" basis,
## WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for
## the specific language governing rights and limitations under the License.
## 
## The Original Code is Reddit.
## 
## The Original Developer is the Initial Developer.  The Initial Developer of
## the Original Code is CondeNet, Inc.
## 
## All portions of the code written by CondeNet are Copyright (c) 2006-2009
## CondeNet, Inc. All Rights Reserved.
################################################################################
<%!
   import datetime, locale
   def num(x):
      return locale.format('%d', x, True)
 %>
<div class="calendar">
  <%
     today = datetime.datetime.now(g.tz).date()
   %>
  %for i in xrange(thing.total_size):
    <%
       left = "%.2f" % (100*float(i)/thing.total_size)
       right = "%.2f" %  (100 - 100*float(i+1)/thing.total_size)
       day = thing.start_date + datetime.timedelta(i)
       CPC = CPM = imp_traffic = cli_traffic = "---"
       if thing.promo_traffic.has_key(day):
           imp_traffic, cli_traffic = thing.promo_traffic[day]
           if thing.market.has_key(i):
              CPM = "$%.2f CPM" % (thing.market[i] * 1000./max(imp_traffic, 1))
              CPC = "$%.2f CPC" % (thing.market[i] * 1./max(cli_traffic, 1))
           imp_traffic = num(imp_traffic)
           cli_traffic = num(cli_traffic)
           if day == today:
              imp_traffic = "(%s)" % imp_traffic
              cli_traffic = "(%s)" % cli_traffic
     %>
    <div class="grid ${'today' if day == today else ''}" 
         style="left:${left}%; right:${right}%">
      <div class="header">
        ${day}
      </div>
      <div class="header total">
        ${imp_traffic}<br/>
        ${CPM}
      </div>
      <div class="header total">
        ${cli_traffic}<br/>
        ${CPC}
      </div>
      <div class="header total">
        ${"$%.2f" % thing.market[i] if thing.market.has_key(i) else "---"}
      </div>      
    </div>
  %endfor

<% 
   prev_end = 0
 %>
%for link, start, end in thing.promote_blocks:
 %if start != end:
  %if prev_end > start:
    <% prev_end = 0 %>
    <div class="clearleft"></div>
  %endif
  <%
     margin = "%.2f" % (float(100*(start-prev_end))/thing.total_size)
     width  = "%.2f" % (float(100*(end-start))/thing.total_size)
     prev_end = end
   %>  
  <div class="blob promotedlink ${link.rowstyle} rounded"
         style="width: ${width}%; margin-left: ${margin}%">
    <div class="bid">
        $${int(link.promote_bid)}
    </div>
    <a class="title" 
       href="/promoted/edit_promo/${link._id36}"
       title="${link.title}">
      ${link.author.name}
    </a>
  </div>
 %endif
%endfor
</div>
<div class="clear"></div>

<h1>${_("total promotion traffic")}</h1>
%if thing.imp_graph:
  <img class="traffic-graph" src="${thing.imp_graph}"
       alt="impressions graph"/>
%endif
%if thing.cli_graph:
   <img class="traffic-graph" src="${thing.cli_graph}" 
        alt="click graph"/>
%endif

<div class="clear"></div>
  %if thing.recent:
  <h1>${_('promotions this month')}</h1>
  
  <table class="traffic-table">
    <tr>
      <th colspan="2">Impresions</th>
      <th colspan="2">Clicks</th>
      <th></th>
      <th></th>
    </tr>
    <tr>
      <th>date</th>
      <th>unique</th>
      <th>total</th>
      <th>unique</th>
      <th>total</th>
      <th>points</th>
      <th>title</th>
    </tr>
    %for link, uimp, nimp, ucli, ncli in thing.recent:
    <tr>
      <td style="white-space:nowrap">
        ${link._date.strftime("%Y-%m-%d")}
      </td>
      <td>${num(uimp)}</td>
      <td>${num(nimp)}</td>
      <td>${num(ucli)}</td>
      <td>${num(ncli)}</td>
      <td>${link._ups - link._downs}</td>
      <td style="text-align:left">
        <a class="title" href="${link.permalink}">${link.title}</a>
      </td>
    </tr>
    %endfor
  </table>
  %endif
